{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">{{ project.title }}</h2>
<p><strong>Category:</strong> {{ project.category.name }}</p>
<p><strong>Goal:</strong> {{ project.goal_amount }} | <strong>Raised:</strong> {{ project.current_amount }}</p>
<p><strong>Deadline:</strong> {{ project.deadline.strftime('%Y-%m-%d') }}</p>
<p><strong>Created at:</strong> {{ project.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
<p>{{ project.description }}</p>

<!-- Progress Bar -->
<div class="progress mb-4">
    {% set pct = (project.current_amount / project.goal_amount * 100) | round(0) if project.goal_amount else 0 %}
    <div class="progress-bar" role="progressbar" style="width: {{ pct }}%">{{ pct }}%</div>
</div>

<!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
{% if user and tier_status %}
  <div class="card mb-4">
    <div class="card-header fw-bold">Your Reward Status</div>
    <div class="card-body">
      <p class="mb-2">Your total donation for this project: <strong>{{ tier_status.total }}</strong></p>
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:40%">Reward</th>
            <th style="width:20%">Min Amount</th>
            <th style="width:20%">Status</th>
            <th style="width:20%">Need More</th>
          </tr>
        </thead>
        <tbody>
        {% for t in tier_status.tiers | sort(attribute='min_amount') %}
          <tr>
            <td>{{ t.name }}</td>
            <td>{{ t.min_amount }}</td>
            <td>{% if t.achieved %}‚úÖ Achieved{% else %}‚è≥ Not yet{% endif %}</td>
            <td>{% if t.achieved %}‚Äî{% else %}{{ t.missing }}{% endif %}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% if tier_status.next_missing %}
        <div class="alert alert-info mb-0">
          Donate <strong>{{ tier_status.next_missing }}</strong> more to reach the next reward tier.
        </div>
      {% endif %}
    </div>
  </div>
{% else %}
  <p><a href="{{ url_for('login') }}">Login</a> to see your reward status and donate.</p>
{% endif %}

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° Donate -->
{% if user %}
  <div class="card mb-4">
    <div class="card-header fw-bold">Donate</div>
    <div class="card-body">
      <form method="post" action="{{ url_for('make_pledge') }}">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Amount</label>
            <input type="number" name="amount" class="form-control" min="1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Choose Reward (optional)</label>
            <select name="reward_tier_id" class="form-select">
              <option value="">-- No reward --</option>
              {% for r in project.reward_tiers | sort(attribute='min_amount') %}
                <option value="{{ r.id }}">
                  {{ r.description }} (Min {{ r.min_amount }})
                  {% if r.qty_remaining is not none %}- left {{ r.qty_remaining }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">Donate</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endif %}

<!-- Leaderboard -->
<h4 class="mt-4">Leaderboard</h4>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Rank</th>
      <th>User</th>
      <th>Total Donated</th>
      <th>Tier</th>
    </tr>
  </thead>
  <tbody>
    {% for row in leaderboard %}
      <tr>
        <td>{{ row.rank }}</td>
        <td>{{ row.username }}</td>
        <td>{{ row.total }}</td>
        <td>
          {% if row.tier == "Gold" %}ü•á Gold
          {% elif row.tier == "Silver" %}ü•à Silver
          {% elif row.tier == "Bronze" %}ü•â Bronze
          {% else %}-{% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
